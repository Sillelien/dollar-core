machine:
  environment:
    previous_release: 0.1.3
    release: 0.1.4
    next_release: 0.1.5
    MAVEN_OPTS: "-Xmx1g -DbuildNumber=${CIRCLE_BUILD_NUM} "
  java:
    version: oraclejdk8

general:
  branches:
    ignore:
      - gh-pages

notify:
  webhooks:
    # A list of hook hashes, containing the url field
    # gitter hook
    - url: https://webhooks.gitter.im/e/0400df6c845f5a09949d

dependencies:
  cache_directories:
    - ~/.gnupg
  pre:
#    - sudo apt-get install -y gpg
    - "./gen-key.sh ${GPG_PASSPHRASE}":
        background: true
    - "mkdir -p ~/.codespotter/ || : "
    - echo "${CODE_SPOTTER_KEY}" > ~/.codespotter/.codespotter-key
    - envsubst < settings.xml > ~/.m2/settings.xml
    - echo "login=neilellis" > ~/.github
    - echo "password=${GITHUB_PASSWORD}" >> ~/.github
    - "[[ $CIRCLE_BRANCH != 'master' ]] || gem install jekyll":
        background: true
    - "[[ $CIRCLE_BRANCH != 'staging' ]] || npm install -g github-changes":
        background: true

  override:
    - echo "Skipping maven dependency resolving."
#    - mvn -q dependency:resolve


test:
  override:
    - sudo ln -fs /usr/share/zoneinfo/Europe/London /etc/localtime
    - "mvn -q -T 1C -Drat.skip -Dsource.skip=true -DgenerateReports=false -Dmaven.javadoc.skip=true integration-test":
        timeout: 600

  post:
#    - mvn org.pitest:pitest-maven:mutationCoverage -pl com.sillelien:dollar-core

deployment:

  staging:
      branch: staging
      commands:
        - git config --global user.email "hello@neilellis.me"
        - git config --global user.name "Neil Ellis"
        - git reset HEAD --hard
        - git clean -fd
        - git checkout master
        - git pull
        - git merge staging -m "Auto merge"
#        - 'github-changes -o neilellis -r dollar -k ${GITHUB_TOKEN} -v  -n "In Progress: ${next_release}"'
        - envsubst '$release:$CIRCLE_BUILD_NUM}' < app_template.yml > app.yml
        - git commit -a -m "Promotion from staging"
        - "git tag ${release} || :"
        - git push --tags
        - git push origin master

  production:
      branch: master
      commands:
        - git config --global user.email "hello@neilellis.me"
        - git config --global user.name "Neil Ellis"
        - mvn versions:set -DnewVersion=${release}-r${CIRCLE_BUILD_NUM}
        - mvn versions:resolve-ranges
        - mvn versions:lock-snapshots
#        - mvn versions:commit
        - mvn -T 1C -Dmaven.test.skip=true -Drat.skip=true -DskipEnforcer -Dmaven.javadoc.skip=true -DgenerateReports=false package
        - pack/pack.sh
        - pack/upload.sh ${release} ${CIRCLE_BUILD_NUM}
        - mvn -Dgpg.passphrase=${GPG_PASSPHRASE} -T 2C deploy site:site site:stage
        - ./build-docs.sh:
            timeout: 360
        - mvn com.code-spotter:codespotter-maven-plugin::check -Drat.skip -DskipEnforcer -Dmaven.test.skip=true -Dmaven.javadoc.skip=true -DgenerateReports=false -pl com.sillelien:dollar-core

#        - mvn scm-publish:publish-scm
#        - mv target/staging/* $CIRCLE_ARTIFACTS


  development:
      branch: dev
      commands:
          - echo "dev"
